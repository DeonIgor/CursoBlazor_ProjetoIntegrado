@page "/products"
@inject HttpClient http

<div class="mb-5">
    <h1 class="display-7">Produtos</h1>
    <p class="lead">
        Esse Componente exemplifica a conexão com banco de dados
    </p>
</div>

@if (productList == null)
{
    <p class="lead">
        Carregando...
    </p>
}
else if (productList.Count == 0)
{
    <p class="text-body-secondary">
        Não há items para exibir
    </p>
    <button class="btn btn-secondary w-auto" @onclick="fetchItems">
        Recarregar Lista
    </button>
}
else
{
    <div class="row-2 col-10">

        <div class="row pb-1">
            <div class="col-9 rounded bg-dark text-white">
                <div class="row py-1">
                    <div class="col-4 fw-semibold text-center">Produto</div>
                    <div class="col-4 fw-semibold text-center">Descrição</div>
                    <div class="col-4 fw-semibold text-center">Valor</div>
                </div>
            </div>
            <div class="col-3 p-0">
                <div class="d-flex justify-content-end">
                    <button class="btn btn-primary w-100 ms-1" @onclick="addItem">
                        Novo
                    </button>
                </div>
            </div>
        </div>

        <div class="row">
            @foreach (var item in productList)
            {
                <EditForm Model="@item.Key" class="d-flex w-100 p-0 pb-1">
                    <DataAnnotationsValidator />

                    @if(item.Value == "readonly")       // Visualização
                    {
                        <input type="text" class="form-control bg-transparent w-25 me-1 text-truncate" @bind="item.Key.Name" disabled />
                        <ValidationMessage For="() => item.Key.Name" />
                        <input type="text" class="form-control bg-transparent w-25 mx-1 text-truncate" @bind="item.Key.Description" disabled />
                        <ValidationMessage For="() => item.Key.Description" />
                        <input type="number" class="form-control bg-transparent w-25 mx-1" @bind="item.Key.Price" disabled />
                        <ValidationMessage For="() => item.Key.Price" />

                        <div class="d-flex w-25">
                            <button class="btn btn-dark w-50 me-1" @onclick="() => editItem(item.Key)">
                                Editar
                            </button>
                            <button class="btn btn-danger w-50" @onclick="e => deleteItem(item.Key)">
                                Deletar
                            </button>
                        </div>
                    }
                    else                                // Edição
                    {
                        <div class="d-flex flex-column w-100">
                            <div class="d-flex w-100 mb-1">
                                <input type="text" class="form-control bg-transparent w-25 me-1 text-truncate" @bind="item.Key.Name" />
                                <ValidationMessage For="() => item.Key.Name" />
                                <input type="text" class="form-control bg-transparent w-25 mx-1 text-truncate" @bind="item.Key.Description" />
                                <ValidationMessage For="() => item.Key.Description" />
                                <input type="number" class="form-control bg-transparent w-25 mx-1" @bind="item.Key.Price" />
                                <ValidationMessage For="() => item.Key.Price" />

                                <div class="d-flex w-25">
                                    <button class="btn btn-success w-50 me-1" @onclick="() => editItem(item.Key)">
                                        Salvar
                                    </button>
                                    <button class="btn btn-danger w-50" @onclick="e => deleteItem(item.Key)">
                                        Deletar
                                    </button>
                                </div>
                            </div>
                            <div class="d-flex w-100">
                                <label class="text-end text-muted w-25 p-2">Categoria:</label>
                                <input type="text" class="form-control bg-transparent w-50 ms-1 text-truncate" @bind="item.Key.Category.Name" />
                            </div>
                        </div>
                    }
                </EditForm>
            }
        </div>
    </div>
}

@code {
    Dictionary<Product, string> productList = new Dictionary<Product, string>();

    protected override async Task OnInitializedAsync()
    {
        await fetchItems();
    }

    async Task fetchItems()
    {
        Product[]? prods;
        try
        {
            prods = await http.GetFromJsonAsync<Product[]>("api/Products");
            foreach (Product p in prods)
            {
                productList.Add(p, "readonly");
            }
        }
        catch(Exception e)
        {
            Console.WriteLine(e.Message);
        }
    }

    async Task addItem()
    {
        Category c = new Category("Categoria A");
        Product p = new Product("Nome A", "Descricao A", 150, c);

        if (productList.Any(pair => pair.Key == p)) return;

        try
        {
            await http.PostAsJsonAsync("api/Products", p);
            productList.Add(p, "readonly");
        }
        catch (Exception e)
        {
            Console.WriteLine(e.Message);
        }
    }

    async Task deleteItem(Product p)
    {
        try
        {
            await http.DeleteAsync($"api/Products/{p.ProductId}");
            productList.Remove(p);
        }
        catch (Exception e)
        {
            Console.WriteLine(e.Message);
        }

    }

    async Task editItem(Product p)
    {
        if (productList[p] == "readonly")
        {
            productList[p] = "";
        }
        else
        {
            productList[p] = "readonly";
            saveItems();
        }
    }


    async Task saveItems()
    {
        
    }
}
